# DICOM IHE Validation Service API

This REST API exposes your MADO (Manifest with Descriptors) and IHE KOS (Key Object Selection) validation capabilities through the Gazelle Validation Service API specification.

## API Endpoints

### 1. Get Validation Profiles
**GET** `/validation/v2/profiles`

Returns a list of available validation profiles.

**Response Example:**
```json
[
  {
    "profileID": "IHE.RAD.XDSI.KOS",
    "profileName": "IHE XDS-I.b Key Object Selection",
    "domain": "RAD",
    "coveredItems": ["DICOM KOS", "Key Object Selection Document"],
    "standards": ["DICOM", "IHE RAD TF-2", "IHE ITI TF-3"],
    "version": "1.0"
  },
  {
    "profileID": "IHE.RAD.MADO",
    "profileName": "IHE Manifest with Descriptors",
    "domain": "RAD",
    "coveredItems": ["DICOM MADO Manifest", "Manifest with Descriptors"],
    "standards": ["DICOM", "IHE RAD TF-2", "IHE ITI TF-3"],
    "version": "1.0"
  }
]
```

### 2. Validate DICOM Content
**POST** `/validation/v2/validate`

Validates DICOM content against a specified profile.

**Request Body:**
```json
{
  "validationProfileId": "IHE.RAD.XDSI.KOS",
  "inputs": [
    {
      "id": "dicom_file",
      "content": "<base64-encoded-dicom-file>",
      "itemId": "12345",
      "location": "https://example.com/dicom/12345"
    }
  ]
}
```

**Request Body (Generate Sample):**
To generate and validate a sample DICOM file, omit the `inputs` array:
```json
{
  "validationProfileId": "IHE.RAD.MADO"
}
```

**Response Example:**
```json
{
  "modelVersion": "2.0",
  "uuid": "7855e9cd-e6b2-4afb-b26c-e204dcfafaa1",
  "dateTime": "2025-12-22T12:18:28.975+0000",
  "disclaimer": "This validation report is generated by DICOM IHE Validation Service and is provided as-is.",
  "overallResult": "PASSED",
  "validationMethod": {
    "validationServiceName": "DICOM IHE Validation Service",
    "validationServiceVersion": "1.0.0",
    "validationProfileID": "IHE.RAD.XDSI.KOS",
    "validationProfileName": "IHE XDS-I.b Key Object Selection",
    "validationProfileVersion": "1.0"
  },
  "inputs": [...],
  "reports": [
    {
      "name": "DICOM IOD Validation",
      "standards": ["DICOM PS3.3", "IHE RAD TF-2"],
      "subReportResult": "PASSED",
      "assertionReports": [
        {
          "description": "DICOM file structure is valid",
          "result": "PASSED",
          "severity": "INFO",
          "priority": "MANDATORY"
        }
      ],
      "subCounters": {
        "numberOfAssertions": 1,
        "numberOfFailedWithInfos": 0,
        "numberOfFailedWithWarnings": 0,
        "numberOfFailedWithErrors": 0,
        "numberOfUnexpectedErrors": 0,
        "numberOfUndefined": 0
      }
    }
  ],
  "counters": {
    "numberOfAssertions": 1,
    "numberOfFailedWithInfos": 0,
    "numberOfFailedWithWarnings": 0,
    "numberOfFailedWithErrors": 0,
    "numberOfUnexpectedErrors": 0,
    "numberOfUndefined": 0
  }
}
```

## Validation Profiles

### IHE.RAD.XDSI.KOS
Validates IHE XDS-I.b Key Object Selection documents. This profile ensures:
- Proper DICOM KOS structure
- Correct SOP Class UID (Key Object Selection Document Storage)
- Required IHE XDS-I.b metadata elements
- Valid references to source instances

### IHE.RAD.MADO
Validates IHE Manifest with Descriptors. This profile ensures:
- Proper DICOM MADO structure
- Correct manifest organization
- Valid image library references
- Proper use of key image descriptors
- Compliance with IHE RAD requirements

## Implementation Details

### Features
- **No External Dependencies**: Uses custom JSON serializer/deserializer
- **Automatic Sample Generation**: Can generate valid samples when no input provided
- **Full Validation**: Integrates with the existing CLIDICOMVerify validator
- **Gazelle Compatible**: Follows Gazelle Validation Service API v2 specification

### Custom Components

1. **Model Classes** (`be.uzleuven.ihe.service.models.*`)
   - ValidationProfile
   - ValidationRequest / ValidationReport
   - AssertionReport
   - ValidationCounters
   - Input / Output models

2. **JSON Mapper** (`SimpleJsonMapper`)
   - Custom implementation without Jackson/Gson
   - Handles serialization and deserialization of API models

3. **API Servlet** (`GazelleValidatorAPI`)
   - Handles HTTP requests
   - Routes to appropriate validators
   - Converts validation results to Gazelle format

## Usage Examples

### Example 1: Get Available Profiles
```bash
curl -X GET http://localhost:8080/validation/v2/profiles \
  -H "Accept: application/json"
```

### Example 2: Validate KOS File
```bash
# Encode DICOM file to base64
BASE64_CONTENT=$(base64 -w 0 kos_sample.dcm)

# Send validation request
curl -X POST http://localhost:8080/validation/v2/validate \
  -H "Content-Type: application/json" \
  -d "{
    \"validationProfileId\": \"IHE.RAD.XDSI.KOS\",
    \"inputs\": [{
      \"content\": \"$BASE64_CONTENT\",
      \"itemId\": \"kos_001\"
    }]
  }"
```

### Example 3: Generate and Validate MADO Sample
```bash
curl -X POST http://localhost:8080/validation/v2/validate \
  -H "Content-Type: application/json" \
  -d "{
    \"validationProfileId\": \"IHE.RAD.MADO\"
  }"
```

## Integration with Existing Code

The API integrates seamlessly with your existing codebase:

- **IHEKOSSampleCreator**: Used to generate sample KOS documents
- **IHEMADOSampleCreator**: Used to generate sample MADO manifests
- **CLIDICOMVerify**: Used for actual validation with profile support
- **Validation Models**: Existing validation infrastructure

## Deployment

To deploy this servlet, add it to your web.xml or use annotation-based configuration:

```xml
<servlet>
    <servlet-name>GazelleValidatorAPI</servlet-name>
    <servlet-class>be.uzleuven.ihe.service.GazelleValidatorAPI</servlet-class>
</servlet>
<servlet-mapping>
    <servlet-name>GazelleValidatorAPI</servlet-name>
    <url-pattern>/validation/v2/*</url-pattern>
</servlet-mapping>
```

## Compliance

This implementation follows:
- Gazelle Validation Service API v2.0
- DICOM PS3.3 Information Object Definitions
- IHE RAD Technical Framework Volume 2
- IHE ITI Technical Framework Volume 3 (XDS-I.b)

## Error Handling

The API returns appropriate HTTP status codes:
- **200 OK**: Successful validation
- **400 Bad Request**: Invalid request format or missing required fields
- **404 Not Found**: Unknown validation profile or endpoint
- **500 Internal Server Error**: Validation processing error

## Future Enhancements

Potential improvements:
- Authentication/authorization support
- Batch validation support
- Asynchronous validation for large files
- Additional IHE profiles (XDS-I.b, ATNA, etc.)
- WebSocket support for real-time validation updates

